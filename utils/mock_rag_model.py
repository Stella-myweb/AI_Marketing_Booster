# OpenAI API 없이 작동하는 대체 모델 파일

import os
from typing import Dict, List, Any, Optional, Tuple
import random
import time
import textwrap

# 자체 모듈 임포트
from utils.vector_store import VectorStore

# 설정 로드
from config import REPORT_TITLE, COMPANY_NAME

class MockRAGModel:
    """
    OpenAI API 없이 작동하는 Retrieval-Augmented Generation 모델 클래스
    사전 정의된 응답을 사용하여 API 호출 없이 테스트할 수 있습니다.
    """
    
    def __init__(self):
        """MockRAG 모델 초기화"""
        print("MockRAG 모델이 초기화되었습니다. 이것은 테스트용 모델입니다.")
        # API를 사용하지 않으므로 VectorStore 초기화를 건너뜁니다
        # self.vector_store = VectorStore()
    
    def generate_response(self, query: str, context: str = None, n_results: int = 3) -> str:
        """
        쿼리에 대한 응답을 생성합니다. (API 없이 사전 정의된 응답 사용)
        
        Args:
            query: 사용자 질문
            context: 기존 컨텍스트 (사용하지 않음)
            n_results: 검색할 결과 수 (사용하지 않음)
            
        Returns:
            생성된 응답
        """
        # 진단 시간 시뮬레이션
        time.sleep(1)
        
        # 미리 정의된 응답들
        responses = {
            "네이버 플레이스에서 대표 키워드를 어떻게 최적화해야 하나요?": 
                "네이버 플레이스에서 대표 키워드를 최적화하려면 다음과 같은 방법을 활용하세요:\n\n"
                "1. 고객이 실제로 검색하는 키워드를 조사하세요. 네이버 검색어 트렌드나 키워드 도구를 활용할 수 있습니다.\n"
                "2. 가장 관련성 높은 3-5개의 키워드를 선택하세요. 너무 많은 키워드를 넣으면 효과가 분산됩니다.\n"
                "3. 업종 + 지역명 조합을 활용하세요. 예: '강남 피부과', '홍대 맛집'\n"
                "4. 경쟁이 심한 일반 키워드보다 특화된 키워드를 추가하세요. 예: '24시 동물병원', '프리미엄 스시 오마카세'\n"
                "5. 키워드를 정기적으로 검토하고 업데이트하세요. 계절, 트렌드에 따라 효과적인 키워드는 변할 수 있습니다.",
            
            "리뷰 관리는 어떻게 하는 것이 좋을까요?":
                "효과적인 리뷰 관리 방법은 다음과 같습니다:\n\n"
                "1. 모든 리뷰에 24-48시간 내에 답변하세요. 좋은 리뷰든 나쁜 리뷰든 모두 중요합니다.\n"
                "2. 부정적인 리뷰에는 공감을 표현하고, 문제 해결 의지를 보여주세요. 가능하다면 보상이나 재방문 기회를 제공하세요.\n"
                "3. 긍정적인 리뷰에는 감사 인사와 함께 재방문을 환영한다는 메시지를 남기세요.\n"
                "4. 리뷰 답변에 키워드를 자연스럽게 포함시키면 SEO에 도움이 됩니다.\n"
                "5. 리뷰 작성을 독려하는 QR코드나 안내문을 매장에 비치하세요.\n"
                "6. 리뷰 데이터를 분석하여 지속적인 서비스 개선에 활용하세요."
        }
        
        # 질문에 해당하는 응답이 있으면 반환, 없으면 기본 응답 반환
        if query in responses:
            return responses[query]
        else:
            return (
                "네이버 스마트 플레이스 최적화를 위해서는 다음과 같은 핵심 요소들을 고려해야 합니다:\n\n"
                "1. 기본 정보의 정확성과 완전성 - 영업시간, 휴무일, 연락처, 위치 정보 등을 최신 상태로 유지하세요.\n"
                "2. 고품질 이미지 - 전문적인 사진으로 첫인상을 강화하세요.\n"
                "3. 상세 설명 최적화 - 핵심 키워드를 포함한 매력적인 설명을 작성하세요.\n"
                "4. 리뷰 관리 - 모든 리뷰에 신속하고 친절하게 답변하세요.\n"
                "5. 정기적인 업데이트 - 새로운 소식, 이벤트, 메뉴 등을 지속적으로 업데이트하세요.\n\n"
                "이러한 요소들을 종합적으로 관리하면 검색 노출과 방문율을 크게 향상시킬 수 있습니다."
            )
    
    def generate_diagnosis_report(self, answers: Dict[str, str], diagnosis_result: Dict[str, Any]) -> Dict[str, Any]:
        """
        자가진단 결과를 바탕으로 진단 보고서를 생성합니다. (API 없이 테스트용)
        """
        time.sleep(2)
        level = diagnosis_result["level"]["name"]
        improvements = diagnosis_result.get("improvements", {})
        weak_areas = [area['stage'] for area in improvements.get('weak_areas', [])]
        weak_areas_str = ", ".join(weak_areas) if weak_areas else "없음"
        stage_scores = diagnosis_result.get("stage_scores", {})
        strength_areas = [
            stage for stage, score_info in stage_scores.items() 
            if score_info['avg_score'] >= 4.0
        ]
        strength_areas_str = ", ".join(strength_areas) if strength_areas else "없음"

        # 1000자 종합진단
        overview = textwrap.shorten(
            (
                f"현재 네이버 스마트 플레이스 마케팅은 '{level}' 단계로 진단됩니다. "
                f"강점 영역: {strength_areas_str if strength_areas_str else '없음'} / "
                f"개선 필요 영역: {weak_areas_str if weak_areas_str else '없음'}. "
                "스마트 플레이스의 기본 정보, 이미지, 리뷰, 예약 시스템 등 주요 항목을 종합적으로 평가하였으며, "
                "고객 유입부터 재방문 유도까지의 전체 마케팅 퍼널을 분석하였습니다. "
                "강점 영역은 현재 잘 관리되고 있으나, 개선이 필요한 영역에서는 구체적인 실행 방안이 필요합니다. "
                "특히, 최신 트렌드 반영, 차별화된 콘텐츠, 고객 경험 개선이 중요합니다. "
                "향후에는 데이터 기반의 지속적 개선과 경쟁사 벤치마킹을 통해 한 단계 더 도약할 수 있습니다. "
                "아래 각 영역별 상세 분석과 액션 플랜을 참고하여 실질적인 개선을 추진해보세요. "
                "(이 보고서는 AI 기반 모의 진단 결과로, 실제 현장 상황에 따라 조정이 필요할 수 있습니다.)"
            ),
            width=1000,
            placeholder="..."
        )

        # 개선점 분석을 더 구체적으로
        improvements_analysis = (
            f"[문제 진단] 현재 '{', '.join(weak_areas)}' 영역에서 점수가 낮게 나타났습니다. "
            "이 영역들은 고객이 비즈니스를 발견하고, 클릭하고, 방문하며, 재방문하는 전체 여정에서 핵심적인 병목 구간입니다. "
            "주요 문제점은 다음과 같습니다:\n"
        )
        for area in weak_areas:
            improvements_analysis += f"- {area}: "
            if area == "검색 노출 최적화":
                improvements_analysis += "키워드 설정 미흡, 상세 설명 부족, 위치 정보 부정확 등으로 검색 결과 상위 노출이 어렵습니다.\n"
            elif area == "클릭율 높이는 전략":
                improvements_analysis += "이미지 품질 저하, 차별화 포인트 부족, 매력적인 문구 미흡 등으로 클릭 유도가 약합니다.\n"
            elif area == "머물게 한다":
                improvements_analysis += "콘텐츠 업데이트 빈도 낮음, 이벤트/프로모션 부족, 정보의 신뢰성 부족 등으로 체류시간이 짧습니다.\n"
            elif area == "문의/예약 전환율 높이기":
                improvements_analysis += "예약/문의 기능 미활성화, 전환 유도 문구 부족, 응답 속도 저하 등으로 전환율이 낮습니다.\n"
            elif area == "고객 재방문 유도 전략":
                improvements_analysis += "리뷰 관리 미흡, 단골 고객 관리 부족, 재방문 유도 프로모션 부재 등으로 재방문율이 낮습니다.\n"
            else:
                improvements_analysis += "구체적 개선 필요.\n"
        improvements_analysis += "\n각 문제점에 대한 원인 분석과 개선 방안은 아래 액션 플랜을 참고하세요."

        # 기존 템플릿 활용
        templates = {
            "초기 단계": self._get_beginner_template(weak_areas_str, strength_areas_str),
            "발전 단계": self._get_intermediate_template(weak_areas_str, strength_areas_str),
            "고급 단계": self._get_advanced_template(weak_areas_str, strength_areas_str),
            "최적화 단계": self._get_optimized_template(weak_areas_str, strength_areas_str)
        }
        template = templates.get(level, templates["초기 단계"])

        return {
            "title": f"네이버 스마트 플레이스 최적화 진단 보고서",
            "level": level,
            "overview": overview,
            "strengths_analysis": template["strengths_analysis"],
            "improvements_analysis": improvements_analysis,
            "action_plan": template["action_plan"]
        }
    
    def _get_beginner_template(self, weak_areas: str, strength_areas: str) -> Dict[str, str]:
        """초기 단계 템플릿 응답"""
        return {
            "overview": (
                f"현재 네이버 스마트 플레이스 마케팅은 초기 단계로 진단됩니다. 기본적인 정보는 등록되어 있으나, "
                f"여러 영역에서 개선이 필요합니다. 특히 {weak_areas} 영역에서 점수가 낮게 나타났습니다.\n\n"
                f"스마트 플레이스의 가능성을 최대한 활용하기 위해서는 체계적인 접근과 지속적인 관리가 필요합니다. "
                f"다양한 기능을 활용하여 고객과의 접점을 늘리고 비즈니스 성과를 향상시킬 수 있습니다."
            ),
            "strengths_analysis": (
                f"현재 {strength_areas} 영역에서 상대적인 강점을 보이고 있습니다만, 전반적으로 더 많은 개선이 필요합니다.\n\n"
                f"이러한 기본적인 강점을 토대로 다른 영역도 체계적으로 강화해 나간다면 빠른 시간 내에 "
                f"스마트 플레이스 마케팅 효과를 크게 향상시킬 수 있을 것입니다."
            ) if strength_areas != "없음" else (
                "현재 플레이스 마케팅에서 특별히 뛰어난 강점 영역은 식별되지 않았습니다. "
                "모든 영역에서 체계적인 개선이 필요합니다."
            ),
            "improvements_analysis": (
                f"{weak_areas} 영역에서 개선이 필요합니다. 이러한 영역들은 고객이 비즈니스를 발견하고, "
                f"방문하며, 궁극적으로 구매로 이어지는 과정에서 중요한 역할을 합니다.\n\n"
                f"이 영역들을 개선함으로써 검색 노출, 클릭률, 방문율, 그리고 궁극적으로 매출 증가까지 "
                f"연결되는 마케팅 퍼널을 강화할 수 있습니다."
            ),
            "action_plan": (
                "기본 정보 최적화:\n"
                "1. 영업시간, 휴무일, 주차 정보 등 모든 기본 정보를 정확하게 입력하세요. (난이도: 쉬움, 우선순위: 높음)\n"
                "2. 매장 위치를 정확히 설정하고 찾아오는 길 안내를 상세히 입력하세요. (난이도: 쉬움, 우선순위: 높음)\n"
                "3. 업종에 맞는 대표 키워드 3-5개를 선정하여 등록하세요. (난이도: 중간, 우선순위: 높음)\n\n"
                
                "이미지 개선:\n"
                "1. 외부, 내부, 상품/서비스를 보여주는 고품질 사진을 최소 5장 이상 등록하세요. (난이도: 중간, 우선순위: 높음)\n"
                "2. 대표 이미지는 매장/서비스의 특징을 가장 잘 보여주는 사진으로 설정하세요. (난이도: 쉬움, 우선순위: 높음)\n\n"
                
                "소통 채널 활성화:\n"
                "1. 예약 시스템을 활성화하고 예약 가능한 시간대를 최신 상태로 유지하세요. (난이도: 중간, 우선순위: 중간)\n"
                "2. 모든 리뷰에 48시간 이내에 친절하게 답변하세요. (난이도: 중간, 우선순위: 중간)\n"
                "3. 방문 고객에게 리뷰 작성을 요청하는 안내문 또는 QR코드를 매장에 비치하세요. (난이도: 쉬움, 우선순위: 중간)"
            )
        }
    
    def _get_intermediate_template(self, weak_areas: str, strength_areas: str) -> Dict[str, str]:
        """발전 단계 템플릿 응답"""
        return {
            "overview": (
                f"현재 네이버 스마트 플레이스 마케팅은 발전 단계로 진단됩니다. 기본적인 요소들이 잘 갖춰져 있으나, "
                f"{weak_areas} 영역에서 추가적인 개선이 필요합니다.\n\n"
                f"지금까지 쌓아온 기반을 토대로 더 전략적인 접근을 통해 한 단계 도약할 수 있는 상황입니다. "
                f"고객 유입부터 재방문 유도까지 전 과정을 더욱 체계화하면 비즈니스 성과를 크게 향상시킬 수 있습니다."
            ),
            "strengths_analysis": (
                f"{strength_areas} 영역에서 뛰어난 성과를 보이고 있습니다. 이는 스마트 플레이스 마케팅의 "
                f"중요성을 이해하고 꾸준히 관리해온 결과입니다.\n\n"
                f"이러한 강점을 활용하여 다른 영역들까지 개선한다면 시너지 효과를 통해 더 큰 성과를 "
                f"얻을 수 있을 것입니다. 특히 고객 경험의 연속성 측면에서 강점 영역과 약점 영역을 "
                f"연결하는 전략이 효과적일 것입니다."
            ) if strength_areas != "없음" else (
                "현재 특정 영역에서 뚜렷한 강점이 보이지는 않지만, 전반적으로 기본기가 갖춰져 있습니다. "
                "모든 영역을 더욱 강화하여 균형 잡힌 스마트 플레이스 마케팅을 구축해 나가는 것이 좋겠습니다."
            ),
            "improvements_analysis": (
                f"{weak_areas} 영역에서 개선이 필요합니다. 이 영역들은 고객 여정에서 중요한 전환점이 되는 "
                f"부분으로, 개선을 통해 비즈니스 성과를 크게 향상시킬 수 있습니다.\n\n"
                f"특히 이 영역들을 개선하면 고객 경험이 더욱 매끄러워지고, 긍정적인 입소문과 재방문율 "
                f"증가로 이어질 수 있습니다. 경쟁업체와의 차별화 포인트로도 활용 가능합니다."
            ),
            "action_plan": (
                "콘텐츠 품질 향상:\n"
                "1. 매장/서비스의 차별점을 강조하는 상세 설명을 작성하세요. (난이도: 중간, 우선순위: 높음)\n"
                "2. 전문 사진작가를 통해 고품질 이미지를 촬영하고 업데이트하세요. (난이도: 중간, 우선순위: 높음)\n"
                "3. 시즌별, 이벤트별 콘텐츠를 정기적으로 업데이트하세요. (난이도: 중간, 우선순위: 중간)\n\n"
                
                "고객 전환율 향상:\n"
                "1. 예약/문의 버튼을 눈에 띄게 배치하고 응답 속도를 높이세요. (난이도: 쉬움, 우선순위: 높음)\n"
                "2. 첫 방문 고객을 위한 특별 혜택을 준비하고 스마트 플레이스에 안내하세요. (난이도: 중간, 우선순위: 중간)\n"
                "3. 고객 질문에 대비한 FAQ를 작성하여 상세 정보에 추가하세요. (난이도: 쉬움, 우선순위: 중간)\n\n"
                
                "충성 고객 확보:\n"
                "1. 모든 리뷰에 맞춤형 답변을 제공하고, 부정적 리뷰는 문제 해결에 초점을 맞추세요. (난이도: 중간, 우선순위: 높음)\n"
                "2. 단골 고객 프로그램을 만들고 이를 스마트 플레이스에 홍보하세요. (난이도: 어려움, 우선순위: 중간)\n"
                "3. 방문 고객에게 '저장' 버튼을 누르도록 안내하는 매장 내 QR코드를 비치하세요. (난이도: 쉬움, 우선순위: 중간)"
            )
        }
    
    def _get_advanced_template(self, weak_areas: str, strength_areas: str) -> Dict[str, str]:
        """고급 단계 템플릿 응답"""
        return {
            "overview": (
                f"현재 네이버 스마트 플레이스 마케팅은 고급 단계로 진단됩니다. 대부분의 영역에서 우수한 성과를 보이고 있으며, "
                f"일부 {weak_areas} 영역에서 약간의 개선 여지가 있습니다.\n\n"
                f"스마트 플레이스 마케팅을 체계적으로 관리하고 있으며, 이를 통해 높은 고객 유입과 전환율을 달성하고 있습니다. "
                f"남은 영역들까지 최적화하면 온라인 마케팅의 효과를 극대화할 수 있을 것입니다."
            ),
            "strengths_analysis": (
                f"{strength_areas} 영역에서 매우 뛰어난 성과를 보이고 있습니다. 이는 지속적인 관리와 "
                f"전략적 접근의 결과입니다.\n\n"
                f"이러한 강점은 비즈니스의 온라인 가시성과 고객 유입에 큰 기여를 하고 있습니다. "
                f"경쟁업체와의 차별화 요소로 작용하며, 온라인에서의 긍정적인 브랜드 이미지 구축에 "
                f"핵심적인 역할을 하고 있습니다."
            ),
            "improvements_analysis": (
                f"{weak_areas} 영역에서 소소한 개선이 필요합니다. 이미 높은 수준의 스마트 플레이스 "
                f"마케팅을 구현하고 있으나, 이 영역들을 더욱 강화하면 완벽한 고객 경험을 제공할 수 있습니다.\n\n"
                f"이러한 개선은 이미 구축된 강점 영역과 시너지를 발휘하여, 전체적인 마케팅 효과를 "
                f"한 단계 더 끌어올릴 것입니다."
            ),
            "action_plan": (
                "고급 콘텐츠 전략:\n"
                "1. 시즌별, 트렌드별 특별 콘텐츠 캘린더를 계획하고 실행하세요. (난이도: 중간, 우선순위: 중간)\n"
                "2. 고객 후기와 성공 사례를 활용한 스토리텔링 콘텐츠를 개발하세요. (난이도: 중간, 우선순위: 중간)\n"
                "3. 짧은 홍보 영상을 제작하여 스마트 플레이스에 추가하세요. (난이도: 어려움, 우선순위: 중간)\n\n"
                
                "고객 경험 최적화:\n"
                "1. 리뷰 데이터를 분석하여 서비스/제품 개선점을 도출하고 반영하세요. (난이도: 중간, 우선순위: 높음)\n"
                "2. 온/오프라인 연계 프로모션을 개발하고 스마트 플레이스를 통해 홍보하세요. (난이도: 중간, 우선순위: 중간)\n"
                "3. 24시간 이내 리뷰 답변 시스템을 구축하고 맞춤형 응대를 제공하세요. (난이도: 중간, 우선순위: 높음)\n\n"
                
                "데이터 기반 최적화:\n"
                "1. 스마트 플레이스 인사이트를 월간으로 분석하고 전략을 조정하세요. (난이도: 중간, 우선순위: 높음)\n"
                "2. A/B 테스트를 통해 최적의 대표 이미지와 키워드를 선정하세요. (난이도: 어려움, 우선순위: 중간)\n"
                "3. 경쟁업체 분석을 통해 차별화 포인트를 강화하고 홍보하세요. (난이도: 중간, 우선순위: 중간)"
            )
        }
    
    def _get_optimized_template(self, weak_areas: str, strength_areas: str) -> Dict[str, str]:
        """최적화 단계 템플릿 응답"""
        return {
            "overview": (
                f"현재 네이버 스마트 플레이스 마케팅은 최적화 단계로 진단됩니다. 거의 모든 영역에서 탁월한 성과를 보이고 있으며, "
                f"소수의 {weak_areas} 영역에서만 약간의 개선 여지가 있습니다.\n\n"
                f"스마트 플레이스 마케팅의 모든 기능을 전략적으로 활용하고 있어, 온라인 가시성과 고객 유입이 최고 수준으로 "
                f"유지되고 있습니다. 이제는 미세 조정과 지속적인 혁신으로 선도적 위치를 유지하는 데 집중할 시점입니다."
            ),
            "strengths_analysis": (
                f"{strength_areas} 영역에서 최고 수준의 성과를 달성하고 있습니다. 이는 장기적이고 "
                f"전략적인 스마트 플레이스 마케팅의 결실입니다.\n\n"
                f"이러한 강점 영역들은 서로 시너지를 발휘하여 통합된 고객 경험을 제공하고 있으며, "
                f"온라인 인지도와 매출 증대에 직접적인 기여를 하고 있습니다. 업계 내 벤치마킹 사례로 "
                f"자리매김할 만한 수준입니다."
            ),
            "improvements_analysis": (
                f"현재 {weak_areas} 영역에서 약간의 개선 여지가 있습니다. 이미 대부분의 영역에서 "
                f"탁월한 성과를 보이고 있으나, 이 부분들까지 완벽하게 최적화하면 절대적인 경쟁 우위를 "
                f"확보할 수 있습니다.\n\n"
                f"이러한 미세 조정은 이미 구축된 우수한 스마트 플레이스 마케팅 시스템의 효율성을 "
                f"더욱 높이고, 장기적으로 지속 가능한 성과를 보장할 것입니다."
            ),
            "action_plan": (
                "혁신적 콘텐츠 전략:\n"
                "1. 360도 가상 투어 기능을 도입하여 매장/서비스 경험을 시각화하세요. (난이도: 어려움, 우선순위: 중간)\n"
                "2. 시즌별 특별 이벤트와 프로모션을 위한 전용 콘텐츠를 개발하세요. (난이도: 중간, 우선순위: 중간)\n"
                "3. 고객 성공 스토리와 후기를 활용한 감성적 마케팅 콘텐츠를 제작하세요. (난이도: 중간, 우선순위: 중간)\n\n"
                
                "고급 고객 관계 관리:\n"
                "1. VIP 고객 전용 특별 혜택 프로그램을 개발하고 스마트 플레이스에 홍보하세요. (난이도: 중간, 우선순위: 중간)\n"
                "2. 리뷰 및 피드백 데이터를 분석하여 서비스/제품 혁신에 반영하세요. (난이도: 어려움, 우선순위: 중간)\n"
                "3. 고객 세그먼트별 맞춤형 커뮤니케이션 전략을 개발하세요. (난이도: 어려움, 우선순위: 중간)\n\n"
                
                "선도적 위치 유지 전략:\n"
                "1. 경쟁 분석을 정기적으로 수행하여 차별화 포인트를 지속적으로 강화하세요. (난이도: 중간, 우선순위: 높음)\n"
                "2. 최신 트렌드와 기술을 지속적으로 모니터링하고 적용하세요. (난이도: 중간, 우선순위: 중간)\n"
                "3. 스마트 플레이스 성과 데이터를 비즈니스 의사결정 과정에 통합하세요. (난이도: 어려움, 우선순위: 중간)"
            )
        }